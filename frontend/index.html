<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEIDS - Autonomous Enterprise Intelligence & Decision System</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .status-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 40px;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #1e3c72;
            background: rgba(30, 60, 114, 0.05);
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
            font-weight: 600;
        }

        .content {
            padding: 40px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3c72;
            margin: 10px 0;
        }

        .card-subtitle {
            font-size: 13px;
            color: #666;
        }

        .upload-zone {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #1e3c72;
            background: #f0f4ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e8edff;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .pipeline-stage {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stage-pending { background: #f0f0f0; color: #999; }
        .stage-running { background: #e3f2fd; color: #2196f3; animation: pulse 1.5s infinite; }
        .stage-completed { background: #e8f5e9; color: #4caf50; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .insight-item {
            padding: 20px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .insight-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-high { background: #ffe0e0; color: #d32f2f; }
        .badge-medium { background: #fff4e0; color: #f57c00; }
        .badge-info { background: #e0f2ff; color: #0288d1; }
        .badge-low { background: #e8f5e9; color: #2e7d32; }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .chart-container {
            width: 100%;
            height: 350px;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .correlation-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .correlation-value {
            font-weight: bold;
        }

        .correlation-strong {
            color: #d32f2f;
        }

        .correlation-moderate {
            color: #f57c00;
        }

        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .config-group input, .config-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        #fileInput {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            width: 0%;
        }

        .report-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .trend-up { color: #4caf50; }
        .trend-down { color: #ef4444; }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üß† AEIDS Enterprise</h1>
                <div class="subtitle">Autonomous Enterprise Intelligence & Decision System v2.0</div>
            </div>
            <div class="status-badge">
                <span>‚óè</span>
                <span id="systemStatus">System Ready</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('upload', this)">üì§ Upload</button>
            <button class="tab" onclick="switchTab('pipeline', this)">‚öôÔ∏è Pipeline</button>
            <button class="tab" onclick="switchTab('insights', this)">üí° Insights</button>
            <button class="tab" onclick="switchTab('visualizations', this)">üìà Charts</button>
            <button class="tab" onclick="switchTab('correlations', this)">üîó Correlations</button>
            <button class="tab" onclick="switchTab('comparison', this)">üîÑ Compare</button>
            <button class="tab" onclick="switchTab('reports', this)">üìÑ Reports</button>
            <button class="tab" onclick="switchTab('config', this)">‚öôÔ∏è Config</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 25px;">System Overview</h2>
                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #e3f2fd; color: #2196f3;">üìÅ</div>
                            <div class="card-title">Datasets</div>
                        </div>
                        <div class="card-value" id="datasetsCount">0</div>
                        <div class="card-subtitle">Files uploaded</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #fff3e0; color: #ff9800;">‚ö†Ô∏è</div>
                            <div class="card-title">Anomalies</div>
                        </div>
                        <div class="card-value" id="anomaliesCount">0</div>
                        <div class="card-subtitle">Issues detected</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #e8f5e9; color: #4caf50;">üîó</div>
                            <div class="card-title">Correlations</div>
                        </div>
                        <div class="card-value" id="correlationsCount">0</div>
                        <div class="card-subtitle">Relationships found</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #f3e5f5; color: #9c27b0;">üìä</div>
                            <div class="card-title">Analyses</div>
                        </div>
                        <div class="card-value" id="analysesCount">0</div>
                        <div class="card-subtitle">Completed runs</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px;">Recent Activity</h3>
                <div id="recentActivity">
                    <div class="empty-state">
                        <div class="empty-state-icon">üî≠</div>
                        <p>No recent activity. Upload data to get started.</p>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px;">Uploaded Files</h3>
                <div id="fileListDashboard">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>No files uploaded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Upload Tab -->
            <div id="upload" class="tab-content">
                <h2 style="margin-bottom: 25px;">Upload Dataset</h2>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
                    <h3>Drop files here or click to browse</h3>
                    <p style="color: #999; margin-top: 10px;">Supports CSV, Excel (up to 500MB)</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="uploadFile()">
                </div>
                <div class="progress-bar" id="uploadProgress" style="display: none;">
                    <div class="progress-fill" id="uploadProgressFill"></div>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipeline" class="tab-content">
                <h2 style="margin-bottom: 25px;">Analysis Pipeline</h2>
                <div style="text-align: center; margin-bottom: 30px;">
<button class="btn btn-primary" onclick="analyzeWithPipeline()" id="pipelineBtn">
    ‚ñ∂Ô∏è Run Analysis Pipeline
</button>

                </div>
                <div id="pipelineStages">
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">1</div>
                        <div>
                            <strong>Data Ingestion</strong>
                            <div style="font-size: 13px; color: #666;">Load and parse datasets</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">2</div>
                        <div>
                            <strong>Preprocessing</strong>
                            <div style="font-size: 13px; color: #666;">Clean, normalize, feature engineering</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">3</div>
                        <div>
                            <strong>Anomaly Detection</strong>
                            <div style="font-size: 13px; color: #666;">Z-score, Isolation Forest, LOF</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">4</div>
                        <div>
                            <strong>Correlation Analysis</strong>
                            <div style="font-size: 13px; color: #666;">Pearson, Spearman correlations</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">5</div>
                        <div>
                            <strong>Causality Testing</strong>
                            <div style="font-size: 13px; color: #666;">Granger causality analysis</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">6</div>
                        <div>
                            <strong>SDG Analysis</strong>
                            <div style="font-size: 13px; color: #666;">Sustainability goal mapping</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">7</div>
                        <div>
                            <strong>Visualization</strong>
                            <div style="font-size: 13px; color: #666;">Generate interactive charts</div>
                        </div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-icon stage-pending">8</div>
                        <div>
                            <strong>Report Generation</strong>
                            <div style="font-size: 13px; color: #666;">Create comprehensive reports</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights" class="tab-content">
                <h2 style="margin-bottom: 25px;">AI-Generated Insights</h2>
                <input type="text" class="search-box" placeholder="üîç Search insights..." id="insightSearch" oninput="filterInsights()">
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterByType('all', this)">All</button>
                    <button class="filter-btn" onclick="filterByType('anomaly', this)">Anomalies</button>
                    <button class="filter-btn" onclick="filterByType('correlation', this)">Correlations</button>
                    <button class="filter-btn" onclick="filterByType('statistics', this)">Statistics</button>
                </div>
                <div id="insightsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ü§ñ</div>
                        <p>No insights yet. Upload and analyze data first.</p>
                    </div>
                </div>
            </div>

            <!-- Visualizations Tab -->
            <div id="visualizations" class="tab-content">
                <h2 style="margin-bottom: 25px;">Data Visualizations</h2>
                <div class="chart-grid" id="chartGrid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No charts available. Analyze data to generate visualizations.</p>
                    </div>
                </div>
            </div>

            <!-- Correlations Tab -->
            <div id="correlations" class="tab-content">
                <h2 style="margin-bottom: 25px;">Correlation Analysis</h2>
                <div id="correlationsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîó</div>
                        <p>No correlations found yet. Analyze data first.</p>
                    </div>
                </div>
            </div>

            <!-- Comparison Tab -->
            <div id="comparison" class="tab-content">
                <h2 style="margin-bottom: 25px;">Dataset Comparison</h2>
                <div style="margin-bottom: 20px;">
                    <label>Select datasets to compare:</label>
                    <div id="comparisonSelector"></div>
                </div>
                <div class="comparison-grid" id="comparisonGrid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîÑ</div>
                        <p>Upload multiple datasets to enable comparison.</p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 25px;">Generated Reports</h2>
                <div id="reportsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No reports generated yet.</p>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="config" class="tab-content">
                <h2 style="margin-bottom: 25px;">System Configuration</h2>
                <div class="config-section">
                    <h3 style="margin-bottom: 20px;">Detection Settings</h3>
                    <div class="config-group">
                        <label>Anomaly Threshold (œÉ)</label>
                        <input type="number" id="anomalyThreshold" value="3" step="0.1" min="1" max="5">
                    </div>
                    <div class="config-group">
                        <label>Correlation Threshold</label>
                        <input type="number" id="correlationThreshold" value="0.7" step="0.05" min="0" max="1">
                    </div>
                    <div class="config-group">
                        <label>Detection Methods</label>
                        <select id="detectionMethods" multiple style="height: 100px;">
                            <option value="zscore" selected>Z-Score</option>
                            <option value="isolation_forest" selected>Isolation Forest</option>
                            <option value="lof" selected>Local Outlier Factor</option>
                            <option value="rolling_mad">Rolling MAD</option>
                            <option value="iqr">IQR Method</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <h3 style="margin-bottom: 20px;">Feature Toggles</h3>
                    <div class="config-group">
                        <div class="toggle" onclick="toggleFeature('llm')">
                            <div class="toggle-switch active" id="toggleLLM"></div>
                            <label>Enable LLM Explanations</label>
                        </div>
                    </div>
                    <div class="config-group">
                        <div class="toggle" onclick="toggleFeature('sdg')">
                            <div class="toggle-switch active" id="toggleSDG"></div>
                            <label>Enable SDG Analysis</label>
                        </div>
                    </div>
                    <div class="config-group">
                        <div class="toggle" onclick="toggleFeature('geo')">
                            <div class="toggle-switch active" id="toggleGeo"></div>
                            <label>Enable Geographic Mapping</label>
                        </div>
                    </div>
                    <div class="config-group">
                        <div class="toggle" onclick="toggleFeature('causality')">
                            <div class="toggle-switch active" id="toggleCausality"></div>
                            <label>Enable Causality Testing</label>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                <button class="btn btn-secondary" onclick="resetConfig()">üîÑ Reset to Defaults</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
const API_BASE = 'http://localhost:8000/api';
let currentAnalysisId = null;
let allInsights = [];
let currentFilter = 'all';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadFiles();
    updateStats();
    loadConfig();
    setInterval(updateStats, 10000);
});

// Tab switcher
function switchTab(tabName, element) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (element) element.classList.add('active');
    const tab = document.getElementById(tabName);
    if (tab) tab.classList.add('active');
}

// Drag and drop (guard if element missing)
const uploadZone = document.getElementById('uploadZone');
if (uploadZone) {
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) uploadFileData(file);
    });
}

async function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput && fileInput.files ? fileInput.files[0] : null;
    if (!file) return;
    await uploadFileData(file);
    if (fileInput) fileInput.value = '';
}

async function uploadFileData(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        updateStatus('Uploading...');
        showProgress(0);
        
        const response = await fetch(`${API_BASE}/upload`, {
            method: 'POST',
            body: formData
        });
        
        showProgress(100);
        
        if (!response.ok) throw new Error('Upload failed: ' + response.status + ' ' + response.statusText);
        
        const result = await response.json();
        showNotification(`‚úÖ ${file.name} uploaded successfully!`, 'success');
        
        await loadFiles();
        await updateStats();
        updateStatus('Upload Complete');
        hideProgress();
        
        return result;
    } catch (error) {
        showNotification('‚ùå Upload failed: ' + error.message, 'error');
        updateStatus('Upload Failed');
        hideProgress();
        console.error('uploadFileData error', error);
        throw error;
    }
}

async function loadFiles() {
    try {
        const response = await fetch(`${API_BASE}/files`);
        if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
        const data = await response.json();
        
        displayFilesInList(data.files || []);
        displayFilesInDashboard(data.files || []);
        updateComparisonSelector(data.files || []);
        
        return data;
    } catch (error) {
        console.error('Failed to load files:', error);
        return { files: [] };
    }
}

function displayFilesInList(files) {
    const fileList = document.getElementById('fileList');
    if (!fileList) return;
    
    if (!files || files.length === 0) {
        fileList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No files uploaded yet</p>';
        return;
    }

    fileList.innerHTML = '<h3 style="margin: 20px 0;">Uploaded Files</h3>';
    
    files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <span style="font-size: 24px;">üìÑ</span>
                <div>
                    <strong>${file.filename}</strong>
                    <div style="font-size: 12px; color: #666;">
                        ${file.rows ?? '-'} rows √ó ${file.columns ?? '-'} columns | ${file.size ? (file.size / 1024).toFixed(2) + ' KB' : '-'}
                    </div>
                </div>
            </div>
            <div class="file-actions">
                <button class="btn btn-primary" onclick="analyzeFile(${file.id})">
                    üîç Analyze
                </button>
                <button class="btn btn-secondary" onclick="viewFileDetails(${file.id})">
                    üëÅÔ∏è View
                </button>
                <button class="btn btn-danger" onclick="deleteFile(${file.id})">
                    üóëÔ∏è
                </button>
            </div>
        `;
        fileList.appendChild(fileItem);
    });
}
async function analyzeWithPipeline(fileId = null) {
    try {
        // 1. SELECT FILE IF PROVIDED
        if (fileId !== null) {
            selectedFileId = fileId;
        }

        // 2. ENSURE FILE IS SELECTED
        if (!selectedFileId) {
            showNotification("Please select a dataset first!", "error");
            return;
        }

        // 3. RUN PIPELINE ANIMATION
        await runPipeline();   // ‚Üê your existing pipeline animation

        // 4. RUN REAL ANALYSIS
        await analyzeFile(selectedFileId);

    } catch (error) {
        console.error(error);
        showNotification("Failed: " + error.message, "error");
    }
}

function displayFilesInDashboard(files) {
    const dashboard = document.getElementById('fileListDashboard');
    if (!dashboard) return;
    
    if (!files || files.length === 0) {
        dashboard.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÅ</div>
                <p>No files uploaded yet.</p>
            </div>
        `;
        return;
    }

    dashboard.innerHTML = '';
    files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h4>üìÑ ${file.filename}</h4>
            <div class="stats-detail">
                ${file.rows ?? '-'} rows √ó ${file.columns ?? '-'} columns<br>
                Uploaded: ${file.uploaded_at ? new Date(file.uploaded_at).toLocaleString() : '-'}
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="analyzeFile(${file.id})">
                    üîç Analyze
                </button>
            </div>
        `;
        dashboard.appendChild(card);
    });
}

async function updateStats() {
    try {
        const response = await fetch(`${API_BASE}/stats`);
        if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
        const stats = await response.json();

        const datasetsCount = document.getElementById('datasetsCount');
        const anomaliesCount = document.getElementById('anomaliesCount');
        const correlationsCount = document.getElementById('correlationsCount');
        const analysesCount = document.getElementById('analysesCount');

        if (datasetsCount) datasetsCount.textContent = stats.datasets ?? 0;
        if (anomaliesCount) anomaliesCount.textContent = stats.total_anomalies ?? 0;
        if (correlationsCount) correlationsCount.textContent = stats.total_correlations ?? 0;
        if (analysesCount) analysesCount.textContent = stats.analyses ?? 0;
    } catch (error) {
        console.error('Failed to update stats:', error);
    }
}

async function deleteFile(fileId) {
    if (!confirm('Delete this file and all associated analyses?')) return;

    try {
        updateStatus('Deleting...');
        const response = await fetch(`${API_BASE}/files/${fileId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Delete failed: ' + response.status);

        showNotification('File deleted successfully.', 'success');
        await loadFiles();
        await updateStats();
        updateStatus('Delete Complete');
    } catch (error) {
        showNotification('‚ùå Delete failed: ' + error.message, 'error');
        updateStatus('Delete Failed');
        console.error('deleteFile error', error);
    }
}

async function analyzeFile(fileId) {
    try {
        updateStatus('Analyzing...');
        const insightsListNode = document.getElementById('insightsList');
        if (insightsListNode) {
            insightsListNode.innerHTML = '<div class="loading"><div class="spinner"></div><p>Running analysis pipeline...</p></div>';
        }
        
        const response = await fetch(`${API_BASE}/analyze/${fileId}`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Analysis failed: ' + response.status);
        
        const result = await response.json();
        currentAnalysisId = fileId;
        
        displayInsights(result);
        displayCharts(result);
        displayCorrelations(result);
        generateReports(result);
        updateRecentActivity(result);
        await updateStats();
        
        updateStatus('Analysis Complete');
        showNotification(`‚úÖ Analysis Complete! Anomalies: ${result.anomaly_count ?? 0}, Correlations: ${result.correlation_count ?? 0}`, 'success');
        
        // attempt to switch to insights tab (best-effort)
        const insightsBtn = document.querySelector('[data-tab="insights"]') || document.querySelector('[onclick*="insights"]');
        switchTab('insights', insightsBtn);
        
        return result;
    } catch (error) {
        showNotification('‚ùå Analysis failed: ' + error.message, 'error');
        updateStatus('Analysis Failed');
        console.error('analyzeFile error', error);
        throw error;
    }
}

function displayInsights(result) {
    const insightsList = document.getElementById('insightsList');
    if (!insightsList) return;
    insightsList.innerHTML = '';
    allInsights = [];

    // Summary card (guard fields)
    const summary = result.summary || {};
    const summaryCard = document.createElement('div');
    summaryCard.className = 'card';
    summaryCard.innerHTML = `
        <h3>üìä Analysis Summary</h3>
        <div style="margin-top: 15px;">
            <p><strong>Dataset:</strong> ${summary.rows ?? '-'} rows √ó ${summary.columns ?? '-'} columns</p>
            <p><strong>Numeric Columns:</strong> ${summary.numeric_columns ?? '-'}</p>
            <p><strong>Anomalies Detected:</strong> ${result.anomaly_count ?? 0}</p>
            <p><strong>Correlations Found:</strong> ${result.correlation_count ?? 0}</p>
            <p><strong>Completed:</strong> ${result.timestamp ? new Date(result.timestamp).toLocaleString() : '-'}</p>
        </div>
    `;
    insightsList.appendChild(summaryCard);

    // Anomaly insights
    if (Array.isArray(result.anomaly_details) && result.anomaly_details.length > 0) {
        result.anomaly_details.forEach((anomaly, idx) => {
            const severity = Math.abs(anomaly.deviation) > 5 ? 'high' : 
                           Math.abs(anomaly.deviation) > 3 ? 'medium' : 'low';
            
            const insight = {
                type: 'anomaly',
                element: createInsightElement({
                    type: 'anomaly',
                    title: `‚ö†Ô∏è Anomaly in ${anomaly.column}`,
                    severity: severity,
                    content: `
                        <p>
                            <strong>Value:</strong> ${typeof anomaly.value === 'number' ? anomaly.value.toFixed(2) : anomaly.value} 
                            (Expected: ${typeof anomaly.expected === 'number' ? anomaly.expected.toFixed(2) : anomaly.expected})<br>
                            <strong>Deviation:</strong> ${typeof anomaly.deviation === 'number' ? anomaly.deviation.toFixed(2) : anomaly.deviation}œÉ from mean<br>
                            <strong>Row Index:</strong> ${anomaly.index ?? '-'}
                        </p>
                    `
                })
            };
            allInsights.push(insight);
            insightsList.appendChild(insight.element);
        });
    }

    // Statistical insights
    if (result.statistics) {
        Object.entries(result.statistics).forEach(([col, stats]) => {
            const insight = {
                type: 'statistics',
                element: createInsightElement({
                    type: 'statistics',
                    title: `üìä Statistics: ${col}`,
                    severity: 'info',
                    content: `
                        <p>
                            Mean: ${typeof stats.mean === 'number' ? stats.mean.toFixed(2) : '-'} | 
                            Median: ${typeof stats.median === 'number' ? stats.median.toFixed(2) : '-'} | 
                            Std: ${typeof stats.std === 'number' ? stats.std.toFixed(2) : '-'}<br>
                            Range: ${typeof stats.min === 'number' ? stats.min.toFixed(2) : '-'} - ${typeof stats.max === 'number' ? stats.max.toFixed(2) : '-'}
                        </p>
                    `
                })
            };
            allInsights.push(insight);
            insightsList.appendChild(insight.element);
        });
    }
}

function createInsightElement(data) {
    const insight = document.createElement('div');
    insight.className = 'insight-item';
    insight.setAttribute('data-type', data.type || 'info');
    insight.innerHTML = `
        <div class="insight-header">
            <strong>${data.title}</strong>
            <span class="insight-badge badge-${data.severity}">${(data.severity || 'info').toUpperCase()}</span>
        </div>
        ${data.content}
    `;
    return insight;
}

function displayCharts(result) {
    const chartGrid = document.getElementById('chartGrid');
    if (!chartGrid) return;
    chartGrid.innerHTML = '';

    // Distribution charts
    if (result.statistics) {
        Object.entries(result.statistics).slice(0, 6).forEach(([col, stats]) => {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            const chartId = `chart-${col.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '')}`;
            chartCard.innerHTML = `
                <h4>üìä ${col} Distribution</h4>
                <div id="${chartId}" class="chart-container"></div>
            `;
            chartGrid.appendChild(chartCard);

            const trace = {
                x: ['Min', 'Mean', 'Median', 'Max'],
                y: [stats.min || 0, stats.mean || 0, stats.median || 0, stats.max || 0],
                type: 'bar'
            };

            const layout = {
                xaxis: { title: 'Metric' },
                yaxis: { title: 'Value' },
                height: 320,
                margin: { t: 20, b: 40, l: 60, r: 20 }
            };

            // Plotly uses the element id string
            try {
                Plotly.newPlot(chartId, [trace], layout, {responsive: true});
            } catch (err) {
                console.warn('Plotly error for chart', chartId, err);
            }
        });
    }

    // Anomaly scatter
    if (Array.isArray(result.anomaly_details) && result.anomaly_details.length > 0) {
        const chartCard = document.createElement('div');
        chartCard.className = 'chart-card';
        chartCard.innerHTML = `
            <h4>‚ö†Ô∏è Anomaly Scatter Plot</h4>
            <div id="anomaly-chart" class="chart-container"></div>
        `;
        chartGrid.appendChild(chartCard);

        const trace = {
            x: result.anomaly_details.map(a => a.index),
            y: result.anomaly_details.map(a => a.deviation),
            mode: 'markers',
            type: 'scatter',
            marker: {
                size: 12,
                // don't specify explicit colors (unless you want to)
                color: result.anomaly_details.map(a => Math.abs(a.deviation)),
                colorscale: 'Reds',
                showscale: true
            },
            text: result.anomaly_details.map(a => `${a.column}: ${typeof a.value === 'number' ? a.value.toFixed(2) : a.value}`),
            hovertemplate: '%{text}<br>Deviation: %{y:.2f}œÉ<extra></extra>'
        };

        try {
            Plotly.newPlot('anomaly-chart', [trace], {
                xaxis: { title: 'Row Index' },
                yaxis: { title: 'Standard Deviations' },
                height: 320,
                margin: { t: 20, b: 40, l: 60, r: 20 }
            }, {responsive: true});
        } catch (err) {
            console.warn('Plotly error for anomaly-chart', err);
        }
    }
}

function displayCorrelations(result) {
    const correlationsList = document.getElementById('correlationsList');
    if (!correlationsList) return;
    
    if (!result.correlations || result.correlations.length === 0) {
        correlationsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîó</div>
                <p>No significant correlations found.</p>
            </div>
        `;
        return;
    }

    correlationsList.innerHTML = '<h3 style="margin-bottom: 20px;">Significant Correlations</h3>';

    const table = document.createElement('table');
    table.className = 'correlation-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Feature 1</th>
                <th>Feature 2</th>
                <th>Correlation</th>
                <th>Strength</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');
    result.correlations.forEach(corr => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${corr.feature1}</strong></td>
            <td><strong>${corr.feature2}</strong></td>
            <td class="correlation-value ${corr.strength === 'strong' ? 'correlation-strong' : 'correlation-moderate'}">
                ${typeof corr.correlation === 'number' ? corr.correlation.toFixed(2) : corr.correlation}
            </td>
            <td>${(corr.strength || '').charAt(0).toUpperCase() + (corr.strength || '').slice(1)}</td>
        `;
    });
    correlationsList.appendChild(table);
}

function generateReports(result) {
    const reportsList = document.getElementById('reportsList');
    if (!reportsList) return;
    reportsList.innerHTML = '';

    const reportCard = document.createElement('div');
    reportCard.className = 'report-card';
    reportCard.innerHTML = `
        <h4>üìÑ Analysis Report - ${new Date().toLocaleDateString()}</h4>
        <p style="margin: 10px 0; color: #666;">
            Comprehensive analysis with ${result.anomaly_count ?? 0} anomalies and ${result.correlation_count ?? 0} correlations
        </p>
        <div class="export-buttons">
            <button class="btn btn-primary" onclick="exportReport('html')">üìÑ Export HTML</button>
            <button class="btn btn-success" onclick="exportReport('pdf')">üìë Export PDF</button>
            <button class="btn btn-secondary" onclick="exportReport('json')">üìä Export JSON</button>
        </div>
    `;
    reportsList.appendChild(reportCard);
}

function updateRecentActivity(result) {
    const activity = document.getElementById('recentActivity');
    if (!activity) return;
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
        <div class="file-info">
            <span style="font-size: 24px;">‚úÖ</span>
            <div>
                <strong>Analysis Completed</strong>
                <div style="font-size: 12px; color: #666;">
                    ${result.anomaly_count ?? 0} anomalies, ${result.correlation_count ?? 0} correlations - ${new Date().toLocaleString()}
                </div>
            </div>
        </div>
    `;
    if (activity.querySelector('.empty-state')) {
        activity.innerHTML = '';
    }
    activity.insertBefore(item, activity.firstChild);
}

async function runPipeline() {
    const stages = document.querySelectorAll('.pipeline-stage .stage-icon');
    const btn = document.getElementById('pipelineBtn');
    if (btn) btn.disabled = true;

    for (let i = 0; i < stages.length; i++) {
        stages[i].className = 'stage-icon stage-running';
        stages[i].textContent = '‚è≥';
        
        await new Promise(resolve => setTimeout(resolve, 800));
        
        stages[i].className = 'stage-icon stage-completed';
        stages[i].textContent = '‚úì';
    }

    if (btn) btn.disabled = false;
    showNotification('‚úÖ Pipeline completed successfully!', 'success');
}

function filterInsights() {
    const searchInput = document.getElementById('insightSearch');
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const insights = document.querySelectorAll('.insight-item');
    
    insights.forEach(insight => {
        const text = insight.textContent.toLowerCase();
        const matchesSearch = text.includes(search);
        const matchesFilter = currentFilter === 'all' || insight.getAttribute('data-type') === currentFilter;
        
        insight.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
    });
}

function filterByType(type, element) {
    currentFilter = type;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    if (element) element.classList.add('active');
    filterInsights();
}

function updateComparisonSelector(files) {
    const selector = document.getElementById('comparisonSelector');
    if (!selector) return;
    if (!files || files.length < 2) {
        selector.innerHTML = '<p style="color: #999;">Need at least 2 datasets</p>';
        return;
    }

    selector.innerHTML = files.map(f => `
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" value="${f.id}"> ${f.filename}
        </label>
    `).join('');
}

function viewFileDetails(fileId) {
    showNotification('File details view - Feature coming soon!', 'info');
}

function exportReport(format) {
    showNotification(`Exporting report as ${format.toUpperCase()}...`, 'info');
    // implement real export logic as needed
}

function toggleFeature(feature) {
    if (!feature) return;
    const toggleId = 'toggle' + feature.toUpperCase()[0] + feature.slice(1);
    const toggle = document.getElementById(toggleId);
    if (toggle) toggle.classList.toggle('active');
}

function saveConfig() {
    const config = {
        anomalyThreshold: document.getElementById('anomalyThreshold') ? document.getElementById('anomalyThreshold').value : null,
        correlationThreshold: document.getElementById('correlationThreshold') ? document.getElementById('correlationThreshold').value : null,
        llm: document.getElementById('toggleLLM') ? document.getElementById('toggleLLM').classList.contains('active') : false,
        sdg: document.getElementById('toggleSDG') ? document.getElementById('toggleSDG').classList.contains('active') : false,
        geo: document.getElementById('toggleGeo') ? document.getElementById('toggleGeo').classList.contains('active') : false,
        causality: document.getElementById('toggleCausality') ? document.getElementById('toggleCausality').classList.contains('active') : false
    };
    localStorage.setItem('aeidsConfig', JSON.stringify(config));
    showNotification('‚úÖ Configuration saved!', 'success');
}

function loadConfig() {
    const config = JSON.parse(localStorage.getItem('aeidsConfig') || '{}');
    if (config.anomalyThreshold && document.getElementById('anomalyThreshold')) document.getElementById('anomalyThreshold').value = config.anomalyThreshold;
    if (config.correlationThreshold && document.getElementById('correlationThreshold')) document.getElementById('correlationThreshold').value = config.correlationThreshold;
}

function resetConfig() {
    localStorage.removeItem('aeidsConfig');
    if (document.getElementById('anomalyThreshold')) document.getElementById('anomalyThreshold').value = 3;
    if (document.getElementById('correlationThreshold')) document.getElementById('correlationThreshold').value = 0.7;
    showNotification('Configuration reset to defaults', 'info');
}

function updateStatus(status) {
    const el = document.getElementById('systemStatus');
    if (el) el.textContent = status;
}

function showProgress(percent) {
    const bar = document.getElementById('uploadProgress');
    const fill = document.getElementById('uploadProgressFill');
    if (bar && fill) {
        bar.style.display = 'block';
        fill.style.width = percent + '%';
    }
}

function hideProgress() {
    setTimeout(() => {
        const bar = document.getElementById('uploadProgress');
        const fill = document.getElementById('uploadProgressFill');
        if (bar && fill) {
            bar.style.display = 'none';
            fill.style.width = '0%';
        }
    }, 1000);
}

function showNotification(message, type) {
    const notification = document.getElementById('notification');
    if (!notification) {
        // fallback: console log
        console.log(`[${type || 'info'}] ${message}`);
        return;
    }
    notification.textContent = message;
    notification.className = 'notification show';
    notification.style.background = type === 'error' ? '#ffe0e0' : 
                                  type === 'success' ? '#e8f5e9' : '#e3f2fd';
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
</script>

</body>
</html>